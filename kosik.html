<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Košík | PokéHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/kosik.css">
</head>

<body>
    <nav class="navbar sticky-bottom navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">
                <img src="img/brand/logo/logo_bila.svg" alt="" height="60">
                <strong>Pokéhub</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-md-0">
                    <li class="nav-item"><a class="nav-link" href="/">Zpět do obchodu</a></li>
                    <li class="nav-item cart-item">
                        <a class="nav-link cart-link" href="#">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-badge">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="cart-container">
        <h1 class="text-center mb-5" style="color: #2E0910; font-weight: 700;">Nákupní košík</h1>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="cart-card">
                    <h3 class="mb-4">Položky v košíku</h3>
                    <div id="cart-items-container">
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Načítání...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cart-card">
                    <h3 class="mb-4">Způsob dopravy</h3>
                    <div id="shipping-options">
                        <div class="shipping-option" onclick="selectShipping(this, 79)">
                            <label class="shipping-label">
                                <span><i class="fas fa-box-open me-2"></i> Zásilkovna - Výdejní místo</span>
                                <span class="fw-bold">79 Kč</span>
                            </label>
                            <input type="radio" name="shipping" value="79" class="d-none">
                        </div>
                        
                        <div class="shipping-option" onclick="selectShipping(this, 109)">
                            <label class="shipping-label">
                                <span><i class="fas fa-truck me-2"></i> PPL - Doručení na adresu</span>
                                <span class="fw-bold">109 Kč</span>
                            </label>
                            <input type="radio" name="shipping" value="109" class="d-none">
                        </div>

                        <div class="shipping-option" onclick="selectShipping(this, 0)">
                            <label class="shipping-label">
                                <span><i class="fas fa-store me-2"></i> Osobní odběr (Praha 9)</span>
                                <span class="fw-bold text-success">Zdarma</span>
                            </label>
                            <input type="radio" name="shipping" value="0" class="d-none">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="cart-card sticky-top" style="top: 20px;">
                    <h3 class="mb-4">Shrnutí objednávky</h3>
                    
                    <div class="summary-row">
                        <span>Hodnota zboží:</span>
                        <span id="summary-subtotal">0 Kč</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Doprava:</span>
                        <span id="summary-shipping">0 Kč</span>
                    </div>

                    <div id="free-shipping-bar" class="my-3">
                        </div>

                    <div class="summary-total summary-row">
                        <span>Celkem:</span>
                        <span id="summary-total">0 Kč</span>
                    </div>

                    <button class="btn-checkout mt-3">
                        Pokračovat k platbě <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="js/kosik.js"></script>

    <script>
        // globalni promenne
        let productsDatabase = {};
        let selectedShippingPrice = 0;
        const FREE_SHIPPING_LIMIT = 5000;

        // nacitani produktu z jsonu
        fetch('data/produkty.json')
            .then(response => response.json())
            .then(data => {
                productsDatabase = data;
                renderCartPage();
            })
            .catch(error => {
                console.error('Chyba při načítání produktů:', error);
                document.getElementById('cart-items-container').innerHTML = '<p class="text-danger">Nepodařilo se načíst produkty.</p>';
            });

        // funkce pro vykresleni kosiku
        function renderCartPage() {
            const cart = getCart(); // funkce z js/kosik.js
            const container = document.getElementById('cart-items-container');
            let subtotal = 0;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-shopping-basket text-muted mb-3" style="font-size: 3em;"></i>
                        <p>Váš košík je prázdný.</p>
                        <a href="index.html" class="btn btn-outline-dark rounded-pill mt-2">Jít nakupovat</a>
                    </div>`;
                updateSummary(0);
                return;
            }

            let html = '';
            
            cart.forEach(item => {
                const productInfo = productsDatabase[item.id];
                
                const imgSrc = productInfo ? productInfo.img : 'img/placeholder.png';
                const stockCount = productInfo ? productInfo.instock : 0;
                const isPresell = productInfo ? productInfo.presell : false;
                
                const linePrice = item.price * item.quantity;
                subtotal += linePrice;

                let stockText = '';
                let disablePlus = false;

                if(isPresell) {
                    stockText = `<span class="text-warning"><i class="fas fa-clock"></i> Předprodej</span>`;
                } else if (stockCount > 0) {
                     stockText = `<span class="text-success"><i class="fas fa-check-circle"></i> Skladem: ${stockCount} ks</span>`;
                     if (item.quantity >= stockCount) disablePlus = true;
                } else {
                    stockText = `<span class="text-danger">Není skladem</span>`;
                }

                html += `
                <div class="cart-item-row">
                    <div class="cart-img-container">
                        <img src="${imgSrc}" alt="${item.name}" class="cart-img">
                    </div>
                    
                    <div class="flex-grow-1">
                        <h5 class="mb-1" style="color: #2E0910; font-weight: bold;">${item.name}</h5>
                        <div class="stock-info">${stockText}</div>
                    </div>

                    <div class="d-flex align-items-center gap-2 cart-actions">
                        <button class="qty-btn" onclick="updateItemQuantity('${item.id}', -1)">
                            <i class="fas fa-minus" style="font-size: 0.8em;"></i>
                        </button>
                        <span class="fw-bold mx-1" style="min-width: 20px; text-align: center;">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateItemQuantity('${item.id}', 1)" ${disablePlus ? 'disabled' : ''}>
                            <i class="fas fa-plus" style="font-size: 0.8em;"></i>
                        </button>
                    </div>

                    <div class="text-end" style="min-width: 100px;">
                        <div class="fw-bold fs-5">${linePrice} Kč</div>
                        <small class="text-muted">${item.price} Kč / ks</small>
                    </div>

                    <button class="btn btn-link text-danger p-0 ms-2" onclick="removeItem('${item.id}')" title="Odstranit">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                `;
            });

            container.innerHTML = html;
            updateSummary(subtotal);
        }

        function selectShipping(element, price) {
            document.querySelectorAll('.shipping-option').forEach(el => el.classList.remove('shipping-selected'));
            document.querySelectorAll('input[name="shipping"]').forEach(inpt => inpt.checked = false);
            element.classList.add('shipping-selected');
            const radio = element.querySelector('input');
            radio.checked = true;

            selectedShippingPrice = price;
            
            const cart = getCart();
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            updateSummary(subtotal);
        }

        function updateSummary(subtotal) {
            const shippingEl = document.getElementById('summary-shipping');
            const totalEl = document.getElementById('summary-total');
            const subtotalEl = document.getElementById('summary-subtotal');
            const freeShipBar = document.getElementById('free-shipping-bar');

            let finalShippingPrice = selectedShippingPrice;
            let freeShippingText = '';

            if (subtotal >= FREE_SHIPPING_LIMIT) {
                finalShippingPrice = 0;
                freeShippingText = `
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                    <small class="text-success fw-bold">Dopravu máte ZDARMA!</small>
                `;
                if (selectedShippingPrice > 0) {
                     shippingEl.innerHTML = `<span class="text-muted text-decoration-line-through me-2">${selectedShippingPrice} Kč</span> <span class="text-success">0 Kč</span>`;
                } else {
                     shippingEl.innerHTML = `0 Kč`;
                }
            } else {
                const remaining = FREE_SHIPPING_LIMIT - subtotal;
                const percent = (subtotal / FREE_SHIPPING_LIMIT) * 100;
                freeShippingText = `
                    <div class="progress mb-1" style="height: 5px;">
                        <div class="progress-bar bg-warning" style="width: ${percent}%"></div>
                    </div>
                    <small class="text-muted">Chybí ${remaining} Kč do dopravy zdarma.</small>
                `;
                shippingEl.textContent = selectedShippingPrice === 0 && !document.querySelector('.shipping-selected') ? "Vyberte dopravu" : selectedShippingPrice + " Kč";
            }

            subtotalEl.textContent = subtotal + " Kč";
            totalEl.textContent = (subtotal + finalShippingPrice) + " Kč";
            freeShipBar.innerHTML = freeShippingText;
        }
    </script>
</body>
</html>